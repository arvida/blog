<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Heroku process scheduling on the cheap</title>
  <meta name="description" content="Most web apps have different highs and lows of traffic during the day. Maybe you get most of your traffic during daytime and not so much during the night and...">
  <meta name="google-site-verification" content="hSpvUvfiI4gbjIkE-nZd8otj75nYYr3bjL0kiNH1osg" />

  <link href='http://fonts.googleapis.com/css?family=Shanti' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://blog.arvidandersson.se/2013/08/16/heroku-process-scheduling-on-the-cheap">
  <link rel="alternate" type="application/rss+xml" title="waiworinao ★ notes by arvid andersson" href="http://blog.arvidandersson.se/feed.xml" />

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">waiworinao ★ notes by arvid andersson</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        <a class="page-link" href="http://arvidandersson.se">About</a>
        <a class="page-link" href="https://twitter.com/arvid_a">@arvid_a</a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Heroku process scheduling on the cheap</h1>
    <p class="post-meta">Aug 16, 2013</p>
  </header>

  <article class="post-content">
    <p>Most web apps have different highs and lows of traffic during the day. Maybe you get most of your traffic during daytime and not so much during the night and early morning. If you have this kind of situation it can be a good idea to adjust your number of dynos according to the changes in traffic in order to save a few bucks. When this is done automatic it is sometimes called auto-scaling or process scheduling.</p>

<p>There are <a href="https://addons.heroku.com/process-scheduler">a few services</a> that can do this for you. However it is pretty easy to setup by your self, just using Heroku and some ruby code. And it can be for free.</p>

<h2 id="background">Background</h2>

<ul>
  <li>Each Heroku app gets <a href="https://devcenter.heroku.com/articles/usage-and-billing#750-free-dyno-hours-per-app">750 dyno-hours for free</a> each month.</li>
  <li>Heroku offers a free cron-like add-on called <a href="https://addons.heroku.com/scheduler">Heroku Scheduler</a> for running periodical tasks.</li>
  <li>With the <a href="https://devcenter.heroku.com/articles/platform-api-reference">Heroku API</a> we easily can scale the number of dynos for our apps.</li>
</ul>

<h2 id="putting-it-together">Putting it together</h2>

<h3 id="the-scaling-utility-app">The scaling utility app</h3>

<p>Create a new ruby project with a Gemfile:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">source</span> <span class="s2">"https://rubygems.org"</span>

<span class="n">ruby</span> <span class="s2">"2.0.0"</span>

<span class="n">gem</span> <span class="s2">"heroku-api"</span></code></pre></figure>

<p>Create a ruby file “scaler.rb” that handles the API interactions:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1">#!/usr/bin/env ruby</span>

<span class="nb">require</span> <span class="s2">"bundler"</span>
<span class="nb">require</span> <span class="s2">"optparse"</span>

<span class="no">Bundler</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:default</span><span class="p">)</span>

<span class="n">heroku_api_key</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"HEROKU_API_KEY"</span><span class="p">]</span> <span class="o">||</span> <span class="k">raise</span><span class="p">(</span><span class="s2">"No Heroku API key env variable set"</span><span class="p">)</span>

<span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
<span class="no">OptionParser</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">opts</span><span class="o">|</span>
  <span class="n">opts</span><span class="p">.</span><span class="nf">banner</span> <span class="o">=</span> <span class="s2">"Usage: </span><span class="si">#{</span><span class="no">ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> [options]"</span>
  <span class="n">opts</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="s2">"-a"</span><span class="p">,</span> <span class="s2">"--app NAME"</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">options</span><span class="p">[</span><span class="ss">:app</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="p">}</span>
  <span class="n">opts</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="s2">"-t"</span><span class="p">,</span> <span class="s2">"--type DYNO_TYPE"</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">options</span><span class="p">[</span><span class="ss">:type</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="p">}</span>
  <span class="n">opts</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="s2">"-d"</span><span class="p">,</span> <span class="s2">"--dynos NO_DYNOS"</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">options</span><span class="p">[</span><span class="ss">:count</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="p">}</span>
<span class="k">end</span><span class="p">.</span><span class="nf">parse!</span>

<span class="k">raise</span> <span class="no">OptionParser</span><span class="o">::</span><span class="no">MissingArgument</span><span class="p">,</span> <span class="s2">"--app"</span> <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="ss">:app</span><span class="p">].</span><span class="nf">nil?</span>
<span class="k">raise</span> <span class="no">OptionParser</span><span class="o">::</span><span class="no">MissingArgument</span><span class="p">,</span> <span class="s2">"--type"</span> <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="ss">:type</span><span class="p">].</span><span class="nf">nil?</span>
<span class="k">raise</span> <span class="no">OptionParser</span><span class="o">::</span><span class="no">MissingArgument</span><span class="p">,</span> <span class="s2">"--dynos"</span> <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="ss">:count</span><span class="p">].</span><span class="nf">nil?</span>

<span class="n">heroku</span> <span class="o">=</span> <span class="no">Heroku</span><span class="o">::</span><span class="no">API</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">api_key: </span><span class="n">heroku_api_key</span><span class="p">)</span>
<span class="n">heroku</span><span class="p">.</span><span class="nf">post_ps_scale</span> <span class="n">options</span><span class="p">[</span><span class="ss">:app</span><span class="p">],</span> <span class="n">options</span><span class="p">[</span><span class="ss">:type</span><span class="p">],</span> <span class="n">options</span><span class="p">[</span><span class="ss">:count</span><span class="p">]</span></code></pre></figure>

<h3 id="deploying">Deploying</h3>

<p>Create a new Heroku app and push the code:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">$ </span>heroku apps:create my-auto-scaler
<span class="gp">$ </span>git push heroku master</code></pre></figure>

<p>Setup your Heroku API key as environment variable, you find this on <a href="https://dashboard.heroku.com/account">your account page</a>:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">$ </span>heroku config:set <span class="nv">HEROKU_API_KEY</span><span class="o">=</span>my-api-key</code></pre></figure>

<p>Add the Heroku Scheduler add-on:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">$ </span>heroku addons:add scheduler:standard</code></pre></figure>

<p>Open up the schedulers setting page:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">$ </span>heroku addons:open scheduler:standard</code></pre></figure>

<p>Set up jobs for when your want to scale your app.</p>

<p>For example if you create a job with the task:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">ruby scaler.rb -a my-app -t web -d 3</code></pre></figure>

<p>.. and set the next run to 5:00 UTC. The number of web dynos for the app “my-app” will be scaled to 3 at 5:00 in the morning UTC.</p>

<h2 id="a-little-advice">A little advice</h2>

<p>If you are planning on doing this on a production app make sure you got some error tracking to get alerted if the scheduled tasks has failed to run. It is mentioned in <a href="https://devcenter.heroku.com/articles/scheduler">the docs</a> that “Scheduler is known to occasionally (but rarely) miss the execution of scheduled jobs”. For example I added <a href="https://github.com/arvida/thief-in-the-night">e-mail alerts and logging to StatHat</a>.</p>

  </article>


  <div id="disqus_thread" style="clear:both;"></div>
  <script type="text/javascript" src="http://disqus.com/forums/blog-arvidandersson/embed.js"></script>
  <noscript>
    <a href="http://disqus.com/forums/blog-arvidandersson/?url=ref">View the discussion thread.</a>
  </noscript>
  <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

</div>

      </div>
    </div>

    <footer class="site-footer">
  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p>waiworinao ★ a blog by <a href="http://arvidandersson.se/">Arvid Andersson</a></p>
      </div>

    </div>
  </div>
</footer>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-20637790-3', 'arvidandersson.se');
ga('require', 'displayfeatures');
ga('send', 'pageview');
</script>


  </body>

</html>
