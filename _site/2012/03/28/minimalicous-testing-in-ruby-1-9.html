<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Minimalicious testing in Ruby 1.9 with MiniTest</title>
  <meta name="description" content="In this blog post I am going to try to do a introduction on writing tests in the style of Behavior Driven Development (BDD) specifications, also called specs...">
  <meta name="google-site-verification" content="hSpvUvfiI4gbjIkE-nZd8otj75nYYr3bjL0kiNH1osg" />

  <link href='http://fonts.googleapis.com/css?family=Shanti' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://blog.arvidandersson.se/2012/03/28/minimalicous-testing-in-ruby-1-9">
  <link rel="alternate" type="application/rss+xml" title="waiworinao ★ notes by arvid andersson" href="http://blog.arvidandersson.se/feed.xml" />

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">waiworinao ★ notes by arvid andersson</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        <a class="page-link" href="http://arvidandersson.se">About</a>
        <a class="page-link" href="https://twitter.com/arvid_a">@arvid_a</a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Minimalicious testing in Ruby 1.9 with MiniTest</h1>
    <p class="post-meta">Mar 28, 2012</p>
  </header>

  <article class="post-content">
    <p>In this blog post I am going to try to do a introduction on writing tests in the style of <a href="http://en.wikipedia.org/wiki/Behavior_Driven_Development">Behavior Driven Development (BDD) specifications</a>, also called specs, with ruby’s <a href="https://github.com/seattlerb/minitest"><strong>MiniTest</strong></a> framework. BDD is a big subject and I am going to focus on the tools MiniTest provides for specifying the behaviour of code. There are a lot more to BDD than what is mentioned in this blog post.</p>

<p><em>I got the idea for the blog post while I was reading the excellent <a href="http://pragprog.com/book/achbd/the-rspec-book">The RSpec book</a>. Even though it is about a different testing framework called <a href="http://rspec.info/">RSpec</a> I highly recommend reading it if you are interested in <a href="http://en.wikipedia.org/wiki/Test_automation">automated testing</a> as it gives a great introduction on writing tests and what to think about when doing so. This blog post is kind of a  summary of my notes and thoughts that come up when looking into MiniTest::Spec while reading the the RSpec book and also a few bits I have picked up on my own journey towards learning to test my code better.</em></p>

<h2 id="minitest">MiniTest?</h2>

<p>Since ruby 1.9 the ruby standard library has included a testing framework called <a href="http://www.ruby-doc.org/stdlib-1.9.3/libdoc/minitest/unit/rdoc/MiniTest.html">MiniTest</a>, it is a modern and lightweight replacement for ruby 1.8’s <a href="http://ruby-doc.org/stdlib-1.8.7/libdoc/test/unit/rdoc/Test/Unit.html">Test::Unit</a> framework. MiniTest provides:</p>

<ul>
  <li>Unit tests with <a href="http://www.ruby-doc.org/stdlib-1.9.3/libdoc/minitest/unit/rdoc/MiniTest/Unit.html">MiniTest::Unit</a></li>
  <li>Specs with <a href="http://www.ruby-doc.org/stdlib-1.9.3/libdoc/minitest/spec/rdoc/MiniTest/Spec.html">MiniTest::Spec</a></li>
  <li>mock objects with <a href="http://www.ruby-doc.org/stdlib-1.9.3/libdoc/minitest/mock/rdoc/MiniTest/Mock.html">MiniTest::Mock</a></li>
  <li>algorithm performance tests</li>
</ul>

<p>If you got ruby 1.9 MiniTest is installed and ready to go.</p>

<p>Apart from beeing a sweet testing framwork that is included in ruby by default one of the great things with MiniTest is that the codebase is small and easy to read through. If you want to have a look at the code it is available at GitHub on <a href="https://github.com/seattlerb/minitest">github.com/seattlerb/minitest</a>. Another great thing is that it performs very well when it comes to speed.</p>

<p>MiniTest is maintained and developed by <a href="http://www.zenspider.com/">Ryan Davis</a> of <a href="http://www.seattlerb.org/">Seattle Ruby Brigade</a>.</p>

<p><span id="installing"></span><em>If you need to install ruby 1.9 checkout <a href="http://beginrescueend.com/">Ruby Version Manager</a> or <a href="https://github.com/sstephenson/rbenv">rbenv</a> for easy installation and mangement of ruby versions.</em></p>

<h3 id="a-note-on-minitest-versions">A note on MiniTest versions</h3>

<p>One thing to be aware of is that the version of MiniTest included with your ruby is probably not the most recent version, on ruby 1.9.3-p125 version 2.5.1 looks to be included by default. The latest version of MiniTest is 2.11.3 (as of March 1 2012). If you experience something that looks like a bug or a missing feature that <a href="http://docs.seattlerb.org/minitest/index.html">the documentation</a> says should be there a old version might be the reason.</p>

<p>If you want to install the latest version (or are on ruby 1.8) just do <code class="highlighter-rouge">gem install minitest</code> in your shell like usual when installing <a href="http://rubygems.org/">ruby gems</a>. You will also have to add to following to your tests in order to activate the gem version:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">"rubygems"</span>
<span class="n">gem</span> <span class="s2">"minitest"</span></code></pre></figure>

<p>If you are using <a href="http://gembundler.com/">bundler</a> you just have to add <code class="highlighter-rouge">gem "minitest"</code> to your <code class="highlighter-rouge">Gemfile</code> and do the <code class="highlighter-rouge">bundle</code> command.</p>

<p>You can check your current version of MiniTest with irb:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">~ $ irb
ruby-1.9.3-p125 :001 &gt; require 'minitest/unit'
=&gt; true
ruby-1.9.3-p125 :002 &gt; MiniTest::Unit::VERSION
=&gt; "2.11.2"</code></pre></figure>

<p>There is a <a href="https://github.com/seattlerb/minitest/blob/master/History.txt">History.txt</a> in the github repository for MiniTest that can be worth checking for info on the different versions if you run in to problems.</p>

<h2 id="describing-your-code-with-specs">Describing your code with specs</h2>

<p>Writing specs is about specifying the behavior of your code by creating examples on how the code behaves. MiniTest provides a <a href="http://en.wikipedia.org/wiki/Domain-specific_language">domain specific language</a> for doing this with <a href="http://docs.seattlerb.org/minitest/MiniTest/Spec.html">MiniTest::Spec</a>.</p>

<p>You basically use two methods called <code class="highlighter-rouge">describe</code> and <code class="highlighter-rouge">it</code> along with expectations that specifies what is needed to be fulfilled in order for the example to pass.</p>

<ul>
  <li><code class="highlighter-rouge">describe</code> defines what you are specifying. It takes a string (or something that can act as string) as a first argument. Also it lets you specify a optional “additional description” as a second argument.</li>
  <li><code class="highlighter-rouge">it</code> defines a example (or “test case”). It takes a description along with a block as arguments, the block contains the code that is the “actual example“.</li>
  <li>expectations are implemented as methods you can call on any object, for example <code class="highlighter-rouge">person.name.must_equal 'Yukihiro'</code>, <code class="highlighter-rouge">result.wont_be_empty</code> and <code class="highlighter-rouge">duvel.abv.must_be_close_to 8.5</code>.</li>
</ul>

<p>A spec for a very simple <code class="highlighter-rouge">Person</code> class would look like something like this:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">"minitest/autorun"</span>

<span class="n">describe</span> <span class="s2">"Person"</span><span class="p">,</span> <span class="s2">"A simple person example"</span> <span class="k">do</span>

  <span class="n">it</span> <span class="s2">"has a full name"</span> <span class="k">do</span>
    <span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Yukihiro"</span><span class="p">,</span> <span class="s2">"Matsumoto"</span><span class="p">)</span>
    <span class="n">person</span><span class="p">.</span><span class="nf">full_name</span><span class="p">.</span><span class="nf">must_equal</span> <span class="s2">"Yukihiro Matsumoto"</span>
  <span class="k">end</span>

<span class="k">end</span></code></pre></figure>

<p>The code above should be pretty self explanatory; we give an example on how a person has a full name that is based on it’s first and last name. One thing that can be easy to miss in the beginning is the <code class="highlighter-rouge">require "minitest/autorun"</code> line, this is needed to include the MiniTest code and to trigger the actual execution of the test when the file run.</p>

<h3 id="running-the-person-spec">Running the Person spec</h3>

<p>First make sure that you are using ruby 1.9 by checking the output of <code class="highlighter-rouge">ruby -v</code>:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ ruby -v
ruby 1.9.3p125 (2012-02-16 revision 34643) [x86_64-darwin11.3.0]</code></pre></figure>

<p>If not checkout <a href="#installing">the ruby version managers mentioned above</a>.</p>

<p>Now, create a folder with two sub folders called “lib” and  “spec”. Create a file called “person_spec.rb” with the code listed above for the Person spec and save it to the spec folder then open up your terminal and run it:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ cd my-test-folder
$ ruby spec/person_spec.rb</code></pre></figure>

<p>You should see something like this as the output:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Run options: --seed 57181

# Running tests:

E

Finished tests in 0.000852s, 1173.7089 tests/s, 0.0000 assertions/s.

  1) Error:
test_0001_has_a_full_name(Person::A simple person example):
NameError: uninitialized constant Person
	spec/person_spec.rb:7:in `block (2 levels) in &lt;main&gt;'

1 tests, 0 assertions, 0 failures, 1 errors, 0 skips</code></pre></figure>

<p>Now add a file called person.rb in the “lib” folder and require that file in person_spec.rb:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'minitest/autorun'</span>
<span class="nb">require_relative</span> <span class="s2">"../lib/person"</span>

<span class="n">describe</span> <span class="s2">"Person"</span><span class="p">,</span> <span class="s2">"A simple person example"</span> <span class="k">do</span>
<span class="p">.</span><span class="nf">.</span><span class="o">.</span></code></pre></figure>

<p>Run spec again and start writing code to fix the errors. You should end up with a <code class="highlighter-rouge">Person</code> class that might look something like this:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Person</span>
  <span class="kp">attr_reader</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">)</span>
    <span class="vi">@first_name</span> <span class="o">=</span> <span class="n">first_name</span>
    <span class="vi">@last_name</span> <span class="o">=</span> <span class="n">last_name</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">full_name</span>
    <span class="s2">"</span><span class="si">#{</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">last_name</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>This is how the output of running the spec should look like after we have added a Person class with the <code class="highlighter-rouge">full_name</code> method:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ ruby spec/person_spec.rb
Run options: --seed 65168

# Running tests:

.

Finished tests in 0.000668s, 1497.0060 tests/s, 1497.0060 assertions/s.

1 tests, 1 assertions, 0 failures, 0 errors, 0 skips</code></pre></figure>

<p>There is <a href="#running">a section further down in this post</a> with more info on running specs.</p>

<h3 id="nesting-describe">Nesting describe</h3>

<p>Worth noting is that the <code class="highlighter-rouge">describe</code> method can also be nested to better outline different cases and states. Here we add a <code class="highlighter-rouge">valid?</code> method to the Person class:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">"minitest/autorun"</span>
<span class="nb">require_relative</span> <span class="s2">"../lib/person"</span>

<span class="n">describe</span> <span class="no">Person</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">"when name is empty"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"is not valid"</span> <span class="k">do</span>
      <span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span>
      <span class="n">person</span><span class="p">.</span><span class="nf">wont_be</span> <span class="ss">:valid?</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"when name is not empty"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"is valid"</span> <span class="k">do</span>
      <span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Yukihiro"</span><span class="p">,</span> <span class="s2">"Matsumoto"</span><span class="p">)</span>
      <span class="n">person</span><span class="p">.</span><span class="nf">must_be</span> <span class="ss">:valid?</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"has a full name"</span> <span class="k">do</span>
      <span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Yukihiro"</span><span class="p">,</span> <span class="s2">"Matsumoto"</span><span class="p">)</span>
      <span class="n">person</span><span class="p">.</span><span class="nf">full_name</span><span class="p">.</span><span class="nf">must_equal</span> <span class="s2">"Yukihiro Matsumoto"</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span></code></pre></figure>

<h3 id="setting-expectations">Setting expectations</h3>

<p>MiniTest::Spec provides a bunch of different expectations you can use to create examples. If you have used RSpec one of the big differences you will notice is that MiniTest::Spec uses “must” instead of “should” and “wont” instead of “should_not”.</p>

<p>There is a common practice of limiting the number of expectations to as few
as possible per example, preferably one. The idea is that the examples gets easier to write and maintain by limiting the scope for each one.</p>

<h4 id="available-expectations">Available expectations</h4>

<p>The full list of available expectations is available in <a href="http://docs.seattlerb.org/minitest/MiniTest/Expectations.html">the documentation</a> for MiniTest. A few of the highlights:</p>

<ul>
  <li><code class="highlighter-rouge">book.title.must_equal 'Lord of the rings'</code></li>
  <li><code class="highlighter-rouge">book.title.must_be_nil</code></li>
  <li><code class="highlighter-rouge">book.title.must_match /Jello/</code></li>
  <li><code class="highlighter-rouge">params[:post_ids].must_include 23</code></li>
  <li><code class="highlighter-rouge">params[:post_ids].must_be_empty</code></li>
  <li><code class="highlighter-rouge">result.must_be_instance_of ChocolateFactory</code></li>
  <li><code class="highlighter-rouge">proc { subject.rm_f }.must_output "* Warning: Deleting all files!"</code> for expecting output to stdout/stderr</li>
  <li><code class="highlighter-rouge">result.must_be_close_to 2.55, 0.005</code> the result must be within 2.545 and 2.555,  for comparing floats</li>
  <li><code class="highlighter-rouge">player.wow_level.must_be :&gt;, 32</code></li>
  <li><code class="highlighter-rouge">kitten.must_be :cute?</code> this only works in MiniTest from version 2.6.0</li>
</ul>

<p>You can make negative expectations by changing <code class="highlighter-rouge">must_</code> to <code class="highlighter-rouge">wont_</code> in most cases.</p>

<h2 id="hooks">Hooks</h2>

<p>MiniTest offers two hooks called <code class="highlighter-rouge">before</code> and <code class="highlighter-rouge">after</code> that you can use to specify a block of code that will be executed before and/or after each example. The hooks can be specified multiple times, however you should only use them once on each level of describe to ensure clarity. These are useful to avoid repetition between the examples.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">describe</span> <span class="no">Person</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"name is empty"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"is not valid"</span> <span class="k">do</span>
      <span class="vi">@person</span><span class="p">.</span><span class="nf">valid?</span><span class="p">.</span><span class="nf">wont_equal</span> <span class="kp">true</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"name is not empty"</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="vi">@person</span><span class="p">.</span><span class="nf">first_name</span> <span class="o">=</span> <span class="s2">"Yukihiro"</span>
      <span class="vi">@person</span><span class="p">.</span><span class="nf">last_name</span> <span class="o">=</span> <span class="s2">"Matsumoto"</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"is valid"</span> <span class="k">do</span>
      <span class="vi">@person</span><span class="p">.</span><span class="nf">valid?</span><span class="p">.</span><span class="nf">must_equal</span> <span class="kp">true</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"has a full name"</span> <span class="k">do</span>
      <span class="vi">@person</span><span class="p">.</span><span class="nf">full_name</span><span class="p">.</span><span class="nf">must_equal</span> <span class="s2">"Yukihiro Matsumoto"</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span></code></pre></figure>

<p>There is also a special hook called <code class="highlighter-rouge">after_tests</code> that allows you to execute a block of code after the whole test suit has been run. This hook can also be invoke multiple times to add more code to be run after the tests are done, however in most cases I would recommend to only invoke this once and in a <a href="#multipletestfiles">spec_helper</a> or similar file to avoid confusion.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">MiniTest</span><span class="o">::</span><span class="no">Unit</span><span class="p">.</span><span class="nf">after_tests</span> <span class="k">do</span>
  <span class="n">destroy_sandbox</span>
  <span class="nb">puts</span> <span class="vg">$debug_info</span>
<span class="k">end</span></code></pre></figure>

<h2 id="helpers">Helpers</h2>

<p>MiniTest provides a couple of helper methods to make your specs easier to read more convinient to write.</p>

<h3 id="let">let</h3>

<p><code class="highlighter-rouge">let</code> is like simplified version of the before hook that you use to setup predefined accessors and the values they return:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">describe</span> <span class="no">Person</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:person</span><span class="p">)</span> <span class="p">{</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Yukihiro"</span><span class="p">,</span> <span class="s2">"Matsumoto"</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="s2">"has a full name"</span> <span class="k">do</span>
    <span class="n">person</span><span class="p">.</span><span class="nf">full_name</span><span class="p">.</span><span class="nf">must_equal</span> <span class="s2">"Yukihiro Matsumoto"</span>
  <span class="k">end</span>

<span class="k">end</span></code></pre></figure>

<h3 id="subject">subject</h3>

<p><code class="highlighter-rouge">subject</code> works similar to let but you can only use it to set a accessor called subject. This is used to specify the object who’s behavior is being described:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">describe</span> <span class="no">Person</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Yukihiro"</span><span class="p">,</span> <span class="s2">"Matsumoto"</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="s2">"has a full name"</span> <span class="k">do</span>
    <span class="n">subject</span><span class="p">.</span><span class="nf">full_name</span><span class="p">.</span><span class="nf">must_equal</span> <span class="s2">"Yukihiro Matsumoto"</span>
  <span class="k">end</span>

<span class="k">end</span></code></pre></figure>

<h3 id="specify">specify</h3>

<p><code class="highlighter-rouge">specify</code> is a alias for <code class="highlighter-rouge">it</code>, it is usually used where it doesn’t make sense to describe the example with a string:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">describe</span> <span class="no">Person</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>

  <span class="n">specify</span> <span class="p">{</span><span class="err"> </span><span class="n">subject</span><span class="p">.</span><span class="nf">posts</span><span class="p">.</span><span class="nf">must_be_empty</span> <span class="p">}</span>

<span class="k">end</span></code></pre></figure>

<h3 id="skip">skip</h3>

<p><code class="highlighter-rouge">skip</code> provides a way to skip examples from being run, the method takes a string as optional argument that can be used to provide a explanation to why that example is skipped:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">describe</span> <span class="no">Ticket</span> <span class="k">do</span>

  <span class="n">it</span> <span class="s2">"expires after one year"</span> <span class="k">do</span>
    <span class="n">skip</span> <span class="s2">"Vending machine clock is broken"</span>
    <span class="n">t</span> <span class="o">=</span> <span class="no">Ticket</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:created_at</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">.</span><span class="nf">year_ago</span><span class="p">)</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">expired?</span><span class="p">.</span><span class="nf">must_be</span> <span class="kp">true</span>
  <span class="k">end</span>

<span class="k">end</span></code></pre></figure>

<p>The code after <code class="highlighter-rouge">skip</code> is not run in the example and is reported as “Skipped” (a S instead of a .) in the output when running the tests:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ ruby spec/ticket_spec.rb
Run options: --seed 48730

# Running tests:

S

Finished tests in 0.000633s, 1579.7788 tests/s, 0.0000 assertions/s.

1 tests, 0 assertions, 0 failures, 0 errors, 1 skips</code></pre></figure>

<p>This can be handy if you want to hide error messages while doing <a href="http://en.wikipedia.org/wiki/Refactoring">refactorings</a> or to describe a bug that you are not going to fix this very minute.</p>

<p>Another way of doing skips is using the <code class="highlighter-rouge">it</code> method without a block. This can be used to keep a list of tests that you plan to write. As skipped tests gets marked in the output you will get reminded that there are examples left to write.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">describe</span> <span class="no">Ticket</span> <span class="k">do</span>

  <span class="n">it</span> <span class="s2">"expires after one year"</span>
  <span class="n">it</span> <span class="s2">"has a description"</span>
  <span class="n">it</span> <span class="s2">"belongs to a venue"</span>

<span class="k">end</span></code></pre></figure>

<h2 id="test-doubles">Test doubles</h2>

<p>Test doubles are pretend objects that acts as an another object. They are useful when you are writing examples for code that collaborates with other objects as you can focus on writing one example at a time without depending on the implementation and inner workings of the other objects. Test doubles can also make your specs fast and more predicable as you can pretend to make requests to external services or databases and the result. However overuse of test doubles can cause a lot of problems and if your test doubles starts to get complicated it is probably a deeper problem and sign of a <a href="http://en.wikipedia.org/wiki/Code_smell">code smell</a>.</p>

<p>The two most common test double types I have come accross when writing tests are <code class="highlighter-rouge">stubs</code> and <code class="highlighter-rouge">mocks</code>. <em>A stub object</em> is a pretend object that implement some of the interface of the object it pretends to be and returns predefined responses. <em>A mock object</em> is similair to a stub but has another use case: it helps decide if the test case it is used in passes by verifying if it’s methods has been called or not.</p>

<p><em>Read more about different types of test doubles over at <a href="http://en.wikipedia.org/wiki/Test_double">wikipedia</a>.</em></p>

<h3 id="mocking">Mocking</h3>

<p>MiniTest provides a <a href="http://docs.seattlerb.org/minitest/MiniTest/Mock.html">Mock</a> class that is used to create mock objects. You setup expectations for what methods are going to be called on the mock object with a method called <code class="highlighter-rouge">expect</code> that takes the method name and return value as arguments. You can also <a href="http://docs.seattlerb.org/minitest/MiniTest/Mock.html">set what arguments must be passed</a> when calling the method.</p>

<p>To verify if the expectations have been met you call <code class="highlighter-rouge">verify</code> on the mock object, if not all expected methods have been called the example will fail. An example where we want to verify that the <code class="highlighter-rouge">name</code> method on the author object is used when generating a book description:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">describe</span> <span class="no">Book</span> <span class="k">do</span>

  <span class="n">it</span> <span class="s2">"uses authors name in description"</span> <span class="k">do</span>
    <span class="n">author</span> <span class="o">=</span> <span class="no">MiniTest</span><span class="o">::</span><span class="no">Mock</span><span class="p">.</span><span class="nf">new</span>
    <span class="n">author</span><span class="p">.</span><span class="nf">expect</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="s2">"Robin Hobb"</span><span class="p">)</span>
    <span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Royal Assassin"</span><span class="p">,</span> <span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">author</span><span class="p">)</span>

    <span class="n">book</span><span class="p">.</span><span class="nf">description</span><span class="p">.</span><span class="nf">must_match</span> <span class="sr">/Written by Robin Hobb/</span>
    <span class="n">author</span><span class="p">.</span><span class="nf">verify</span>
  <span class="k">end</span>

<span class="k">end</span></code></pre></figure>

<h3 id="stubbing">Stubbing</h3>

<p>When it comes to stubs MiniTest doesn’t provide a solution on how to do this. However there are a couple options on how to do stubbing with what is included in ruby by default.</p>

<p>The simplest way is to just use pure ruby code:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">describe</span> <span class="no">Book</span> <span class="k">do</span>

  <span class="n">it</span> <span class="s2">"includes authors name in description"</span> <span class="k">do</span>
    <span class="n">robin</span> <span class="o">=</span> <span class="no">Class</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span>
      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">name</span>
        <span class="s2">"Robin Hobb"</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="c1"># can also be written like:</span>
    <span class="c1"># 	robin = Class.new</span>
    <span class="c1"># 	def robin.name; "Robin Hobb" end</span>

    <span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Royal Assassin"</span><span class="p">,</span> <span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">robin</span><span class="p">)</span>

    <span class="n">book</span><span class="p">.</span><span class="nf">description</span><span class="p">.</span><span class="nf">must_match</span> <span class="sr">/It is written by Robin Hobb/</span>
  <span class="k">end</span>

<span class="k">end</span></code></pre></figure>

<p>Another approach is using ruby’s <a href="http://ruby-doc.org/core-1.9.3/Struct.html"><code class="highlighter-rouge">Struct</code></a> class:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">describe</span> <span class="no">Book</span> <span class="k">do</span>

  <span class="n">it</span> <span class="s2">"includes authors name in description"</span> <span class="k">do</span>
    <span class="n">author_stub</span> <span class="o">=</span> <span class="no">Struct</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
    <span class="n">robin</span> <span class="o">=</span> <span class="n">author_stub</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Robin Hobb"</span><span class="p">)</span>
    <span class="c1"># can also be written like:</span>
    <span class="c1"># 	robin = Struct.new(:name).new("Robin Hobb")</span>

    <span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Royal Assassin"</span><span class="p">,</span> <span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">robin</span><span class="p">)</span>

    <span class="n">book</span><span class="p">.</span><span class="nf">description</span><span class="p">.</span><span class="nf">must_match</span> <span class="sr">/It is written by Robin Hobb/</span>
  <span class="k">end</span>

<span class="k">end</span></code></pre></figure>

<p>Ruby also provides a alternative <em>struct like</em> class called <a href="http://www.ruby-doc.org/stdlib-1.9.3/libdoc/ostruct/rdoc/OpenStruct.html"><code class="highlighter-rouge">OpenStruct</code></a> which might feel a bit more natural to use than <code class="highlighter-rouge">Struct</code>:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">"ostruct"</span>

<span class="n">describe</span> <span class="no">Book</span> <span class="k">do</span>

  <span class="n">it</span> <span class="s2">"includes authors name in description"</span> <span class="k">do</span>
    <span class="n">robin</span> <span class="o">=</span> <span class="no">OpenStruct</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">"Robin Hobb"</span><span class="p">)</span>
    <span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Royal Assassin"</span><span class="p">,</span> <span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">robin</span><span class="p">)</span>

    <span class="n">book</span><span class="p">.</span><span class="nf">description</span><span class="p">.</span><span class="nf">must_match</span> <span class="sr">/It is written by Robin Hobb/</span>
  <span class="k">end</span>

<span class="k">end</span></code></pre></figure>

<h4 id="partial-stubbing">Partial stubbing</h4>

<p>Partial stubbing is when you want use a “real object” in your tests but want to stub  some of the methods of that object, for example to avoid hitting the network or to freeze the time. These kinds of stubs are easily added in ruby thanks to it’s dynamic workings. Let’s say we want to check that the published at timestamp is glorified correctly for a book:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">describe</span> <span class="no">Book</span> <span class="k">do</span>

  <span class="n">it</span> <span class="s2">"glorifies published at"</span> <span class="k">do</span>
    <span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">new</span>
    <span class="k">def</span> <span class="nc">book</span><span class="o">.</span><span class="nf">published_at</span>
      <span class="no">Time</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">book</span><span class="p">.</span><span class="nf">glorified_published_at</span><span class="p">.</span><span class="nf">must_equal</span> <span class="s2">"The most awesome and first Monday of the glorious year of 2012"</span>
  <span class="k">end</span>

<span class="k">end</span></code></pre></figure>

<h3 id="test-double-libraries">Test double libraries</h3>

<p>There are a couple of gems that provide different and more refined ways to create test doubles that works with MiniTest, for example: <a href="http://mocha.rubyforge.org/">Mocha</a>, <a href="https://github.com/btakita/rr">RR</a> and <a href="http://flexmock.rubyforge.org/">FlexMock</a>.</p>

<p>If you are making HTTP calls in your code also checkout <a href="https://github.com/bblimke/webmock">WebMock</a> and <a href="https://github.com/myronmarston/vcr">VCR</a> for some great ways to mock and stub HTTP services.</p>

<h2 id="running-your-tests">Running your tests</h2>

<p><span id="running"></span>To run a single spec you just feed it to the ruby interpreter:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ ruby spec/beer_spec.rb</code></pre></figure>

<p>Depending of how you require files in your tests you might need to supply ruby with additional paths for $LOAD_PATH with the <code class="highlighter-rouge">-I</code> option:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ ruby -Ilib -Ispec spec/beer_spec.rb</code></pre></figure>

<p>MiniTest provides a verbose output format with the <code class="highlighter-rouge">--verbose</code> (or <code class="highlighter-rouge">-v</code>) option. This will print each example with it’s name and how long it took to run:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ ruby spec/beer_spec.rb --verbose
Run options: --verbose --seed 18215

# Running tests:

Beer#test_0001_has_a_name = 0.00 s = .
Beer#test_0002_has_a_description = 0.00 s = .
Beer#test_0003_can_be_opened = 0.00 s = .


Finished tests in 0.001147s, 2615.5187 tests/s, 2615.5187 assertions/s.

3 tests, 3 assertions, 0 failures, 0 errors, 0 skips</code></pre></figure>

<p>There are also a option for specifying what tests to run based on the name. You do this with the <code class="highlighter-rouge">--name</code> (or <code class="highlighter-rouge">-n</code>) option that you supply with a regex.
Here we only run want to run the example matching “description“:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ ruby spec/beer_spec.rb --name /description/
Run options: --name /description/ --seed 64925

# Running tests:

.

Finished tests in 0.000962s, 1039.5010 tests/s, 1039.5010 assertions/s.

1 tests, 1 assertions, 0 failures, 0 errors, 0 skips</code></pre></figure>

<h3 id="multiple-test-files">Multiple test files</h3>

<p><span id="multipletestfiles"></span>If you have more than one test file <a href="http://rake.rubyforge.org/">rake</a> provides a great way to run multiple tests with it’s <code class="highlighter-rouge">TestTask</code> class. You add a test task by creating a file called “Rakefile” in your projects root with the following contents:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s2">"rake/testtask"</span>

<span class="no">Rake</span><span class="o">::</span><span class="no">TestTask</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">pattern</span> <span class="o">=</span> <span class="s2">"spec/**/*_spec.rb"</span>
<span class="k">end</span></code></pre></figure>

<p>With this rake task you can do <code class="highlighter-rouge">rake test</code> in the shell and all the files in the “spec“ folder ending with “_spec.rb” will be run. The <code class="highlighter-rouge">pattern</code> option tells rake what files to be considered as tests, here the double asterisks makes the rake task look recursivly for test files to run.</p>

<p>There are a few more options you can use to customize test tasks, for example you can provide the task with a option called <code class="highlighter-rouge">libs</code> to add directories to ruby’s <code class="highlighter-rouge">$LOAD_PATH</code> before running the tests. Read more about this <a href="http://rake.rubyforge.org/classes/Rake/TestTask.html">in the Rake documentation</a>.</p>

<p>In order to pass MiniTest options to the rake task you have to put those in a environment variable called TESTOPTS:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ rake test TESTOPTS="--verbose"
Run options: --verbose --seed 18215

# Running tests:

Beer#test_0001_has_a_name = 0.00 s = .
Beer#test_0002_has_a_description = 0.00 s = .
Beer#test_0003_can_be_opened = 0.00 s = .


Finished tests in 0.001147s, 2615.5187 tests/s, 2615.5187 assertions/s.

3 tests, 3 assertions, 0 failures, 0 errors, 0 skips</code></pre></figure>

<p>The <code class="highlighter-rouge">--verbose</code> and <code class="highlighter-rouge">--name</code> options gets especially useful when you have a large test suit and want to see which examples are slow or just want to run a single example when fixing a bug.</p>

<p>If you got code or setup that you share between the specs it is common practice to have a <code class="highlighter-rouge">spec_helper.rb</code> file in the spec folder that contains the shared code that you require in the specs where this code needed.</p>

<p>When you have a big suit of tests that takes some time to you can hit <code class="highlighter-rouge">CTRL-T</code> while the test are running get a progress report.</p>

<h2 id="resources">Resources</h2>

<h3 id="prettifying-the-output">Prettifying the output</h3>

<p>To make the output of running your MiniTest specs a bit more pretty and informative there are a few options; for example checkout <a href="https://github.com/TwP/turn">TURN</a>, <a href="https://github.com/tenderlove/purdytest">purdytest</a> and <a href="https://github.com/CapnKernul/minitest-reporters">minitest-reporters</a>. MiniTests also provides it’s own solution for this called <a href="https://github.com/seattlerb/minitest/blob/master/lib/minitest/pride.rb">pride</a>, just add <code class="highlighter-rouge">require "minitest/pride"</code> to your spec for some fabulousness.</p>

<h3 id="rails">Rails</h3>

<p>As you might have guessed MiniTest::Spec should work great for testing Rails apps. There is a gem called <a href="https://github.com/blowmage/minitest-rails">minitest-rails</a> that lets you use MiniTest::Spec for testing Rails 3 projects. Also checkout a blog post named <a href="http://blog.rawonrails.com/2012/01/better-way-of-testing-rails-application.html">A better way of testing Rails application with minitest</a> by Rafał Wrzochol and one called <a href="http://metaskills.net/2011/03/26/using-minitest-spec-with-rails/">Using MiniTest::Spec With Rails</a> by Ken Collins for more info on getting started with this.</p>

<p>There are also <a href="http://railscasts.com/episodes/327-minitest-with-rails">a RailsCast Pro episode</a> and Avdi Grimm’s excellent book <a href="http://objectsonrails.com/">Objects on Rails</a> that includes a lot of examples on using MiniTest::Spec in a Rails app.</p>

<h3 id="more">More</h3>

<p>Two very recomended talks covering MiniTest are Ryan Davis <a href="http://confreaks.com/videos/618">Size Doesn’t Matter</a> at Cascadia Ruby 2011 and <a href="http://tenderlovemaking.com/">Aaron Patterson</a>’s <a href="http://www.confreaks.com/videos/367-gogaruco2010-hidden-gems-of-ruby-1-9">Hidden Gems of Ruby 1.9</a> from Golden Gate Ruby Conference 2010.</p>

<p>There are a good introduction article on MiniTest::Spec called <a href="http://www.rubyinside.com/a-minitestspec-tutorial-elegant-spec-style-testing-that-comes-with-ruby-5354.html">A MiniTest::Spec Tutorial: Elegant Spec-Style Testing That Comes With Ruby</a> by Peter Cooper over at <a href="http://rubyinside.com/">Ruby Inside</a>.</p>

<p>A tutorial on <a href="https://gist.github.com/2032303">writing your own MiniTest::Spec expectations</a>.</p>

<p>Vim <a href="https://github.com/sunaku/vim-ruby-minitest">syntax highlighting</a> for MiniTest.</p>

  </article>


  <div id="disqus_thread" style="clear:both;"></div>
  <script type="text/javascript" src="http://disqus.com/forums/blog-arvidandersson/embed.js"></script>
  <noscript>
    <a href="http://disqus.com/forums/blog-arvidandersson/?url=ref">View the discussion thread.</a>
  </noscript>
  <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

</div>

      </div>
    </div>

    <footer class="site-footer">
  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p>waiworinao ★ a blog by <a href="http://arvidandersson.se/">Arvid Andersson</a></p>
      </div>

    </div>
  </div>
</footer>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-20637790-3', 'arvidandersson.se');
ga('require', 'displayfeatures');
ga('send', 'pageview');
</script>


  </body>

</html>
