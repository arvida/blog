<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Do the asset serving dance on Heroku Cedar with Rails 3.1 and CloudFront</title>
  <meta name="description" content="The asset pipeline in Rails 3.1 and Heroku’s Cedar stack adds a few new things to think about when serving static assets from your apps. Heroku has removed V...">
  <meta name="google-site-verification" content="hSpvUvfiI4gbjIkE-nZd8otj75nYYr3bjL0kiNH1osg" />

  <link href='http://fonts.googleapis.com/css?family=Shanti' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://blog.arvidandersson.se/2011/10/03/how-to-do-the-asset-serving-dance-on-heroku-cedar-with-rails-3-1">
  <link rel="alternate" type="application/rss+xml" title="waiworinao ★ notes by arvid andersson" href="http://blog.arvidandersson.se/feed.xml" />

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">waiworinao ★ notes by arvid andersson</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        <a class="page-link" href="http://arvidandersson.se">About</a>
        <a class="page-link" href="https://twitter.com/arvid_a">@arvid_a</a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Do the asset serving dance on Heroku Cedar with Rails 3.1 and CloudFront</h1>
    <p class="post-meta">Oct 3, 2011</p>
  </header>

  <article class="post-content">
    <p>The <a href="http://guides.rubyonrails.org/asset_pipeline.html">asset pipeline in Rails 3.1</a> 
and <a href="http://devcenter.heroku.com/articles/cedar">Heroku’s Cedar stack</a> adds a few new 
things to think about when serving static assets from your apps. Heroku has removed 
<a href="https://www.varnish-cache.org/">Varnish</a> and <a href="http://nginx.org/">nginx</a> from 
the the cedar stack which means that static files served from a app won’t get cached or gzipped automagically. 
One way to go is to use Amazon’s S3 as asset host together with the 
<a href="https://github.com/rumblelabs/asset_sync">asset_sync</a> gem. However there are <a href="http://stackoverflow.com/questions/7430578/how-to-universally-skip-database-touches-when-precompiling-assets-on-heroku">a few</a> <a href="https://github.com/rumblelabs/asset_sync/issues/5#issuecomment-2049722">problems</a> 
that can occur when Heroku run <code>rake&nbsp;assets:precompile</code> during the deploy process.</p>

<p>With these facts you might realize that you want to put your compiled assets on a content delivery 
network like Amazon’s <a href="http://aws.amazon.com/cloudfront/">CloudFront</a> so the assets can be served 
fast and your dynos don’t have to be bothered with serving and compiling assets.</p>

<h2>How do we solve this in a good way?</h2>

<p>First create a new CloudFront distribution. A great thing with CloudFront is that you can set any
domain as the source for the distribution. You do this for your Heroku hosted app by specifying 
the apps domain as the ”Custom Origin” when creating a new distribution. With this set CloudFront
don’t need a S3 bucket, instead it will mirror the assets from the custom origin 
domain. When the distribution gets a request for a file that it don’t have mirrored yet it will just
issue the same request to your app, cache the result and return it. This also makes it possible to 
serve gzipped versions of your assets as CloudFront forwards the clients request headers and rack 
can serve gzipped versions of your assets if the client supports it 
(<a href="#ggg-zippd">more on this further down</a>).</p>

<p>Add the new distribution’s domain name (or CNAME if you specifed one) as the the asset host for your app in 
production environment:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># config/environments/production.rb</span>
<span class="p">.</span><span class="nf">.</span>
<span class="n">config</span><span class="p">.</span><span class="nf">action_controller</span><span class="p">.</span><span class="nf">asset_host</span> <span class="o">=</span> <span class="s2">"http://aabbccdd.cloudfront.net"</span>
<span class="p">.</span><span class="nf">.</span></code></pre></figure>

<p>This will make rails add the specified asset host to the generated url when you use <code>stylesheet_link_tag</code> 
or similair helpers in production. For example if you do</p>

<figure class="highlight"><pre><code class="language-erb" data-lang="erb"><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s1">'application'</span> <span class="cp">%&gt;</span></code></pre></figure>

<p>you will get</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">&lt;link href="http://aabbccdd.cloudfront.net/assets/application-388a2a900c29a176d20c18ed000f77fa.css" media="screen" rel="stylesheet" type="text/css" /&gt;</code></pre></figure>

<p>Great, but we are not quite done yet because Heroku will automatically run the rake task to compile
the assets when your app is deployed. This is a problem because if the files that CloudFront requests
exists on disk then they will not be served from your rails app but from the disk, so we won’t get the correct
<a href="https://github.com/sstephenson/sprockets/blob/master/lib/sprockets/server.rb#L203">cache headers</a>
and we won’t be able to serve gzipped versions of the assets.</p>

<h2>What we need to do</h2>

<h3>1. Disable the assets precompile rake task</h3>
<p>There is two ways to do this. By overriding the <code>assets:precompile</code>
rake task:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># lib/tasks/disable_assets_precompile.rake</span>
<span class="no">Rake</span><span class="o">::</span><span class="no">Task</span><span class="p">[</span><span class="s1">'assets:precompile'</span><span class="p">].</span><span class="nf">clear</span>
<span class="n">namespace</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">task</span> <span class="ss">:precompile</span> <span class="k">do</span>
    <span class="nb">puts</span> <span class="s1">'* rake assets:precompile has been disabled (lib/tasks/disable_precompile.rake)'</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>You can also add a empty file called <code>public/assets/manifest.yml</code> to your project, 
if Heroku detects this file it will not run the <code>assets:precompile</code> task on deploy.
Both these ways are kind if hackish, so choose the one that suits you best.</p>

<h3>2. Enable on-the-fly asset compiling in production</h3>
<p>As we now need to serve the assets through the rails stack
when CloudFront makes it’s first requests we need to enable asset compiling in the production environment, 
this is done by setting <code>config.assets.compile</code> to <code>true</code> in your production settings:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># config/environments/production.rb</span>
<span class="p">.</span><span class="nf">.</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">compile</span> <span class="o">=</span> <span class="kp">true</span>
<span class="p">.</span><span class="nf">.</span></code></pre></figure>

<h3 id="ggg-zippd">3. Enable serving of gzipped content</h3>
<p>As Heroku has removed nginx from the cedar stack we have to do the gzipping by ourselves, this is done 
by adding a rack middleware called 
<a href="https://github.com/chneukirchen/rack/blob/master/lib/rack/deflater.rb">Rack::Deflater</a>.
It’s part of <a href="https://github.com/chneukirchen/rack">Rack core</a> so it’s really easy to add,
just update your <code>config.ru</code> file in the root of your rails project to look like this:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="o">::</span><span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="s1">'../config/environment'</span><span class="p">,</span>  <span class="kp">__FILE__</span><span class="p">)</span>
<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Deflater</span>
<span class="n">run</span> <span class="no">MySuperApp</span><span class="o">::</span><span class="no">Application</span></code></pre></figure>

<p><b>Done</b>, deploy your app and celebrate with beer. With this setup you get a geo-aware, fast and 
cachable way to serve your Rails 3.1 assets.</p>

<p><em>Thanks to <a href="https://twitter.com/#!/joeljunstrom">@joeljunstrom</a> for the proofreading!</em></p>

  </article>


  <div id="disqus_thread" style="clear:both;"></div>
  <script type="text/javascript" src="http://disqus.com/forums/blog-arvidandersson/embed.js"></script>
  <noscript>
    <a href="http://disqus.com/forums/blog-arvidandersson/?url=ref">View the discussion thread.</a>
  </noscript>
  <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

</div>

      </div>
    </div>

    <footer class="site-footer">
  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p>waiworinao ★ a blog by <a href="http://arvidandersson.se/">Arvid Andersson</a></p>
      </div>

    </div>
  </div>
</footer>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-20637790-3', 'arvidandersson.se');
ga('require', 'displayfeatures');
ga('send', 'pageview');
</script>


  </body>

</html>
